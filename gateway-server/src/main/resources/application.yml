server:
  port: 8082

spring:
  application:
    name: gateway-server
  
  cloud:
    gateway:
      httpclient:
        connect-timeout: 1000
        response-timeout: 10s
      
      routes:
        # Route vers le client MCP
        - id: mcp-client-route
          uri: http://localhost:8081
          predicates:
            - Path=/mcp/chat/**
          filters:
            - RewritePath=/mcp/chat/(?<segment>.*), /chat/$\{segment}
            - name: CircuitBreaker
              args:
                name: mcpClientCircuitBreaker
                fallbackUri: forward:/fallback/client
        
        # Route vers le serveur MCP
        - id: mcp-server-route
          uri: http://localhost:8080
          predicates:
            - Path=/mcp/server/**
          filters:
            - RewritePath=/mcp/server/(?<segment>.*), /$\{segment}
            - name: CircuitBreaker
              args:
                name: mcpServerCircuitBreaker
                fallbackUri: forward:/fallback/server
            - name: Retry
              args:
                retries: 3
                methods: GET
                backoff:
                  firstBackoff: 100ms
                  maxBackoff: 1000ms
                  factor: 2
                  basedOnPreviousValue: true
        
        # Route vers les actuators
        - id: actuator-route
          uri: http://localhost:8080
          predicates:
            - Path=/actuator/**
          filters:
            - name: RequestRateLimiter
              args:
                redis-rate-limiter:
                  replenishRate: 10
                  burstCapacity: 20
                  requestedTokens: 1
  
  data:
    redis:
      connect-timeout: 2s
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 1s
  
  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: ${KEYCLOAK_JWK_SET_URI:https://localhost:9000/realms/mcp-realm/protocol/openid-connect/certs}
          # Utilisation de jwk-set-uri au lieu de issuer-uri pour éviter les problèmes SSL
      
      client:
        registration:
          keycloak:
            client-id: mcp-client
            client-secret: secret
            authorization-grant-type: client_credentials
            scope: mcp:read,mcp:write
        
        provider:
          keycloak:
            issuer-uri: https://localhost:9000/realms/mcp-realm
            token-uri: https://localhost:9000/realms/mcp-realm/protocol/openid-connect/token

management:
  endpoints:
    web:
      exposure:
        include: "*"
  endpoint:
    gateway:
      enabled: true
  info:
    env:
      enabled: true
  metrics:
    tags:
      application: ${spring.application.name}

info:
  app:
    name: "gateway-server"
    description: "MCP Gateway Server with OAuth2 and routing"
    version: "1.0.0"

logging:
  level:
    com.mcp.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.security: DEBUG
  pattern:
    level: "%5p [${spring.application.name},%X{trace_id},%X{span_id}]"

# Resilience4j Circuit Breaker
resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        permittedNumberOfCallsInHalfOpenState: 2
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
  
  timelimiter:
    configs:
      default:
        timeoutDuration: 10s

